# Global Illumination Based on Surfels
サーフェルと呼ばれる代表点？を使ってGIをリアルタイムに行おうというもの

GlobalIlluminationBased on Surfelsはディフーズの間接光をリアルタイムで処理する手法。この手法はハードウェアライトレーシングとシーンジオメトリの離散化を組み合わせ、時間と空間にわたってライティング計算をキャッシュし棄却します。これは事前計算、特殊なメッシュ、特殊なUVを必要としません。

BIGSアルゴリズムは2018年SEED PICAPICAレイトレーシングショーケースの一部として実装されました。収束時間と品質を改善しながらこのアルゴリズムは拡張され続けており、様々なジオメトリ（スキニングキャラクターや巨大な環境など）を扱えるよう最適化されておいる。

Agenda
- Surfel Discretization (サーフェル離散化)
- Non-Liner Acceleration Structure (非線形高速化構造)
- Irradiance integration Techniques (イラディアンス計算手法)
- Bleeding Mitigation (ブレンド低減)
- Many Light Sampling (複数光源サンプリング)
- Transparency (透明)
- Performance (パフォーマンス)

# Surfelとは
画像をピクセルへと分割することで離散化できると同様にジオメトリーサーフェイスも離散化することができます。これを行う１つの方法としてはサーフェルを使うことです。サーフェルはSurfaceElementsの略で、Surfelはポジション、半径、ノーマルを持ち、与えられたポジションから隣接するサーフェルで近似を行うことができます。（要はジオメトリの代表点）

ではどうやってサーフェルでシーンを離散化するのでしょうか、我々はジオメトリーからビューへと入るものとしてサーフェルをGBufferから生成します。そのあとサーフェルは持続することができ、時間をかけてラディアンスを計算しつつ保存することができます。

生成方法はraytracing hybridの方を参照

実際の生成アルゴリズムはスクリーンスペースを埋めるような形で働きます。スクリーンを16x16のテクセルタイルに分解し、それぞれのタイルは最もカバーできていないテクセルを発見します。ランダムに決めたスレッドフォールドを通過できたら我々は新たにGBufferからのジオメトリ情報を用いて新しくサーフェルを作ります。一度確定した量生成できたらそれ以上はそのタイルでスポーンする必要はありません。

一度スポーンさせたサーフェルは継続しますが、それらは毎フレーム事ポジションを更新します。これを達成するには、サーフェルは取りついてるジオメトリーの識別子を追跡します。

一般にジオメトリのIDを見て新しいポジションへと移動する。
スキニングとかにも使うことができる。

このサーフェライズはシーン中のどんなとこでも行われます。サーフェルはスクリーンスペース状の投影先が大体定数になるようにスケーリングされます。これはスポーンだけじゃなく動かすときも同様です(画面に映る割合を一定するようにすけーりリングする)

この視点では丘の上を見るとサーフェルが縮んでおり、

# acceralation structure
BIGSでは与えられたポジションに対して周りのサーフェルを取得する処理が必要なため、高速化構造が必要となります。
PICAPICAだと簡単なもので単純に単位グリッドによって分けられているだけです。

サーフェルを作ったらそのポジションのグリッドにサーフェルがあることを書き込み、半径からその周囲も同様に書き込みます。不連続性を防ぐため、更に隣接するピクセルにも書き込みます。

PICAPICAはそこまで大きいシーンじゃなかったのでこれでよかったんですが、実際のゲームではより広いシーンとなり、このACでは不十分です。→遠くのサーフェルが大きい領域を占領したりするから

我々のACは近くの部分ではuniform gridですが、ある程度先の部分では視錐台のように広がる形で置かれている。

# Light Apply
　サーフェルの最終パスとして、我々は各ピクセルのポジションをワールドスペースに再生成し、そのポジションがどのセルに含まれるかを見つけ、そのセル内の初めのNサーフェルにフェッチします。

それぞれのサーフェスが持つ（それらの方向や距離などでウェイトをつけ）イラディアンスを蓄積します。それらサーフェスの処理が終わり、もしサーフェスの寄与が１より小さい場合はグリッドセルのイラディアンスのウェイトされた平均において加えます。

# Light Bleeding
単純に位置からサーフェルを見つけるので場合によっては壁を挟んでいるサーフェスを取ってしまい結果として光が盛れてしまうという現象があります。（端の部分とか）
これを防ぐためDepthFunctionという仕組みを作っている。サーフェルには最初持っている半径でDepthFunctionを持っています。レイトレーシングしてイラディアンスを得ようとしており、サーフェル半径内でジオメトリに比っとしたとき、我々はデプスFunctionを更新します。より精度を上げるためレイを複数回当てます。

こうしてデプスを得ることができましたが、直接これを保存しません。我々は深度と深度の二乗のそれぞれの平均を持っておきます
$ E(x) = Z_1 = \sum \frac{z}{n} $ 
$ E(x^2) = Z_2 A= \sum \frac{z^2}{n} $
その分散は以下のように得られます
$ \sigma^2 = E(x^2) - E(x)^2 = Z_2 - Z_1^2$
平均と分散を使うことでChebychevの不等式が使えるため、デプステストができるようになります
$ P(x > t) < \frac{\sigma^2}{\sigma^2 + (t - E(x))}$
tが与えられた値としてx以上である確率をここでは示しています。
→つまりsurfelまでの距離をdとして以上の式からt = dとしてデプステストが通る確率を求め、その割合でウェイトとしてかけてあげる？もしくはデプステストで打ち消す？　ともかくかしこい

半球当たり4x4のテクセルでこれを持っておくことで判定している(低解像度でもアーティファクトが消えるぐらい非常によく働く)
DDGIを参考としているらしいReference参照

# integrating Irradiance
サーフェルのライティングはどのように計算されるか

BIGSでは全て動的でありますので我々は壊れやすく動的な環境と同様に発光するサーフェイスやマテリアルをサポートできます。
我々はこれらの状況において効率的にイラディアンスを積分し、シーンの変化に対応できるようにする必要があります。
そこで登場するのがレイトレーシングです。サーフェルはレイをシーンに放ちます。これらレイは動的、スキニング含めたジオメトリにあたます（ジオメトリは全てレイトレACで構築されている）。この衝突店では、我々は直接発散ライティングとシャドーイングをシーンからトレースすることで計算します。我々はどのように効率的に行っているかについて話します。加えて、ヒットした場所で我々はそこに存在しているサーフェルのライティングを計算します。（当たった地点にサーフェルがあったらそのサーフェルの計算をついでに行う）これは我々にそのエリアでサーフェルの収束が存在するまで効率的に無限のバウンスを与えてくれます。

# RayGlobalRayBudget
サーフェルは各フレームにおいていくつレイを飛ばすかを決める情報をいくつか持っています。これらファクターはサーフェルがどれぐらいシーンに存在しているのか？どれぐらいカメラからライティングされているのかと言って情報を持ちます。実際にカメラから見えるところのサーフェルはよりレイが必要になります。サーフェルが

サーフェルごとのレイカウントは以下の情報から決める
- 分散
- 見えているフレーム数
- スポーンしてからのフレーム数
- グローバルレイバジェット

GlobalRyaBudged

# RayGuiding
重点的サンプリングでも間接光に対しては効果的ではありません。RayGuidingという手法も使用する。
サーフェルは6x6のRadial IrradianceMapというものを持っている。これはどの方向が強いラディアンスを持っていたのかを記録するもので、計算のたびに更新していく。これをもとに重点的サンプリングすると指向性が強い環境でも重点的サンプリングすることができる（IBLとおんなじ感じ）
4Kテクスチャで保存可能

# Irradiance Sharing
一般に近くのサーフェルはそこまで収束先は変わらないため、近くのサーフェルから値を取得することも問題がないはずである。自身の分散が高いときは周りのサーフェルの値をウェイト掛けた上で得ることでアーティファクトを消すことができる。

# RaySorting

# ManyLight Sampling
レイトレの際は光源点のサンプリングを行うため、複数のライトのサンプリングについて論じていく必要がある。

- Sample all the light
- Brute force stochastic sample
- importance sampling
- stochasticLightCuts
- Reservoir Sampling



→サーフェルというものでジオメトリを離散化し、代表点として計算するっぽい（手法としてはフォトマッピングに近い気がしないでもない）。なのでわざわざ何かしらUVなどを用意する必要ななくサーフェルの構造さえあればOKで事前計算無しでもいい。

→ほんとに事前計算無しで大丈夫なのか

